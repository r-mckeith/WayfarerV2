{% extends 'base.html' %}
{% block content  %}


  {% comment %} PROFILE CARD INFORMATION {% endcomment %}
  <div class="row">
    <div class="card col s12 m8 xl6 relative">
      <div class="card-content profile-card-flex">
        <div class="relative profile-picture" style="background-image: url('{{profile.photo_url}}')">
          {% comment %} BUTTON - UPLOAD PICTURE {% endcomment %}
          {% if profile.user_id == user.id %}
          <button class="btn upload-picture-btn"><i class="material-icons">file_upload</i></button>
          {% endif %}
        </div>
        <div class="profile-info">
          <p>{{ profile.first_name }} {{profile.last_name }}</p>
          <p>{{ profile.current_city }}</p>
          <p><small>Member since: {{ user.date_joined }}</small></p>
        </div>
      </div>
      {% if profile.user.id == user.id %}
        {% comment %} MODAL TRIGGER - EDIT PROFILE {% endcomment %}
        <a class="btn modal-trigger edit-btn-profile" href="#modal1"><i class="material-icons">edit</i></a>
      {% endif %}
    </div>
  </div>

  {% comment %} (HIDDEN) CHANGE PROFILE PICTURE FORM {% endcomment %}
  {% if profile.user_id == user.id %}
  <form action="{% url 'add_photo' profile.user_id %}" enctype="multipart/form-data" method="POST" class="picture-form hide">
      {% csrf_token %}
      <input type="file" name="photo-file" class="choose-file">
      <input type="submit">
  </form>   
  {% endif %}

{% comment %} MODAL BODY - EDIT PROFILE {% endcomment %}
<div id="modal1" class="modal">
  <div class="modal-content">

    <h4>Edit Profile</h4>
    <form action="{% url 'profile_edit' %}" method="POST">
      {% csrf_token %}
      {{ profile_form.as_p }}   
      <div class="modal-footer">
        <input type="submit" value="Update">
      </div>
    </form>

    </div>
  </div>

{% comment %} RENDER EVERY POST - MODAL TRIGGER {% endcomment %}
{% for post in posts %}

  <div class="card">
    <div class="card-content">

      <p class="card-title"><a class="modal-trigger" href="#post-modal{{post.id}}">{{ post.title }}</a> <small>posted by: <a href="{% url 'profile' post.user.id %}">{{post.user.username}}</a></small></p>
      <p>{{ post.body|truncatechars_html:200 }}</p>

      {% if post.user.id == user.id %}
        {% comment %} EDIT-POST-MODAL TRIGGER {% endcomment %}
        <button class="modal-trigger" href="#post-edit-modal{{post.id}}">Edit</button>

        {% comment %} DELETE POST FORM {% endcomment %}
        <form action="{% url 'post_delete' post.id %}" method="POST" onclick="return confirm('Are you sure you want to delete \'{{post.title}}\'?')">
          {% csrf_token %}
          <input type="submit" value="Delete">
        </form>
      {% endif %}

    </div>
  </div>

{% comment %} POST SHOW - MODAL BODY {% endcomment %}
<div id="post-modal{{post.id}}" class="modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <p class="card-title">{{ post.title }} <small>posted by: {{user}}</small></p>
        <p>{{ post.body }}</p>
        <small>{{ post.posted }}</small>
      </div>
    </div>

     <h3>Comments</h3>
    {% comment %} COMMENTS {% endcomment %}
    {% for comment in comments %}
    {% if comment.post_id == post.id %}
    <div class="card">
      <div class="card-content">
        <p>{{comment.content}}</p>
        <small>{{comment.user}}</small>
        <small>{{comment.posted}}</small>
      </div>
    </div>
    {% endif %}
    {% endfor %}

    {% comment %} ADD COMMENT MODAL TRIGGER {% endcomment %}
    <button class="modal-trigger" href="#comment-add-modal">Add Comment</button>

    </div>
  </div>

  {% comment %} POST EDIT - MODAL BODY {% endcomment %}
<div id="post-edit-modal{{post.id}}" class="modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <h4>Edit Post</h4>
        <form action="{% url 'post_edit' post.id %}" method="POST">
          {% csrf_token %}
          <input type="text" value="{{ post.title }}" name="title" maxlength="200" required>
          <div class="input-field">
            <textarea class="materialize-textarea" id="edit-body" type="text" name="body" data-length="500" maxlength="500" required>{{ post.body }}</textarea>
          </div>
          <div class="modal-footer">
          <input type="submit" value="Update">
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

{% comment %} MODAL BODY - ADD COMMENT {% endcomment %}
<div id="comment-add-modal" class="modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <h4>Add comment</h4>
        
        <form action="{% url 'comment_new' %}" method="POST">
          {% csrf_token %}
          <div class="input-field">
            <textarea class="materialize-textarea" id="new-body" type="text" name="content" data-length="500" maxlength="500" required></textarea>
          </div>
          <div class="modal-footer">
          <input type="hidden" class="btn" value="{{ post.id }}" name="postId">
          <input type="submit" value="Add Comment">
          </div>
        </form>
      </div>
    </div>

  </div>
</div>


{% endfor %}

<script>

  const edit_modal = document.querySelectorAll('.modal');
  M.Modal.init(edit_modal);
  
  const textNeedCount = document.querySelectorAll('#edit-body');
  M.CharacterCounter.init(textNeedCount);

  //if a new profile picture is selected, then submit the form
  const chooseFileEl = document.querySelector('.choose-file')
  chooseFileEl.addEventListener('change', () => {
    document.querySelector('.picture-form').submit()
  })

  //when you click the upload picture icon, open window to browse for file
  const uploadPictureBtn = document.querySelector('.upload-picture-btn')
  uploadPictureBtn.addEventListener('click', () => {
    chooseFileEl.click()
  })
</script>

{% endblock content  %}