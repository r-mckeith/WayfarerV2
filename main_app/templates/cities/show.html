{% extends 'base.html' %}
{% block content %}

<h1>{{ city.name }}</h1>

<div class="background-image" style="background-image: url('{{city.photo_url}}')"></div>

{% comment %} ADD POST MODAL TRIGGER {% endcomment %}
<button class="modal-trigger btn" href="#post-new-modal">Add Post</button> 

{% comment %} RENDER EVERY POST {% endcomment %}
{% for post in posts %}

  <div class="card">
    <div class="card-content">

      {% comment %} SHOW POST MODAL TRIGGER {% endcomment %}
      <p class="card-title"><a class="modal-trigger" href="#post-modal{{post.id}}">{{ post.title }}</a> <small>posted by: <a href="{% url 'profile' post.user.id %}">{{post.user.username}}</a></small></p>
      <p>{{ post.body|truncatechars_html:200 }}</p>

      {% if post.user.id == user.id %}
        {% comment %} EDIT-POST-MODAL TRIGGER {% endcomment %}
        <button class="modal-trigger" href="#post-edit-modal{{post.id}}">Edit</button> 

        {% comment %} DELETE POST FORM {% endcomment %}
        <form action="{% url 'post_delete' post.id %}" method="POST" onclick="return confirm('Are you sure you want to delete this?')">
          {% csrf_token %}
          <input type="submit" value="Delete">
        </form>
      {% endif %}

    </div>
  </div>


{% comment %} POST SHOW - MODAL BODY {% endcomment %}
<div id="post-modal{{post.id}}" class="modal modal-fixed-footer">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <p class="card-title">{{ post.title }} <small>posted by: {{post.user.username}}</small></p>
        <p>{{ post.body }}</p>
        <small>{{ post.posted }}</small>
      </div>
    </div>

    <h3>Comments</h3>
    {% comment %} COMMENTS {% endcomment %}
    {% for comment in comments %}
    {% if comment.post_id == post.id %}  
    <div class="card">
      <div class="card-content">
        <p>{{comment.content}}</p>
        <small>{{comment.user}}</small>
        <small>{{comment.posted}}</small>
        <p>{{comment.id}}</p>
        {% comment %} ADD COMMENT REPLY MODAL TRIGGER {% endcomment %}
       <button class="modal-trigger reply-modal-trigger" data-comment-id="{{ comment.id }}"href="#reply-modal">Add Reply</button>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
    <div class="modal-footer">
      {% comment %} ADD COMMENT MODAL TRIGGER {% endcomment %}
      <button class="modal-trigger" href="#comment-add-modal">Add Comment</button>

  </div>
</div>

{% comment %} MODAL BODY - ADD REPLY {% endcomment %}
<div id="reply-modal" class="modal reply-modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <h4>Add Reply</h4>
        
        <form action="{% url 'reply_new' %}" method="POST">
          {% csrf_token %}
          <div class="input-field">
            <textarea class="materialize-textarea" id="new-body" type="text" name="content" data-length="500" maxlength="500" required></textarea>
          </div>
          <div class="modal-footer">
          <input id="comment-id" type="hidden" class="btn" value="" name="replyId">
          <input type="hidden" class="btn" value="{{ post.id }}" name="postId">
          <input type="submit" value="Add Reply">
          </div>
        </form>
      </div>
    </div>

  </div>
</div>



  {% comment %} POST EDIT - MODAL BODY {% endcomment %}
<div id="post-edit-modal{{post.id}}" class="modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <h4>Edit Post</h4>
        <form action="{% url 'post_edit' post.id %}" method="POST">
          {% csrf_token %}
          <input type="text" value="{{ post.title }}" name="title" required>
          <input type="text" value="{{ post.body }}" name="body" required>
          <div class="modal-footer">
          <input type="submit" value="Update">
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

{% comment %} MODAL BODY - ADD COMMENT {% endcomment %}
<div id="comment-add-modal" class="modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <h4>Add comment</h4>
        
        <form action="{% url 'comment_new' %}" method="POST">
          {% csrf_token %}
          <div class="input-field">
            <textarea class="materialize-textarea" id="new-body" type="text" name="content" data-length="500" maxlength="500" required></textarea>
          </div>
          <div class="modal-footer">
          <input type="hidden" class="btn" value="{{ post.id }}" name="postId">
          {% comment %} <input type="hidden" class="btn" value={{ comment.id }} name="commentId"> {% endcomment %}
          <input type="submit" value="Add Comment">
          </div>
        </form>
      </div>
    </div>

  </div>
</div>



{% endfor %}

{% comment %} ADD POST - MODAL BODY {% endcomment %}
<div id="post-new-modal" class="modal">
  <div class="modal-content">

    <div class="card">
      <div class="card-content">
        <h4>Add Post</h4>
        
        <form action="{% url 'post_new' %}" method="POST">
          {% csrf_token %}
          <input type="text" value="{{ post.title }}" name="title" maxlength="200" required>
          <div class="input-field">
            <textarea class="materialize-textarea" id="new-body" type="text" name="body" data-length="500" maxlength="500" required>{{ post.body }}</textarea>
          </div>
          <div class="modal-footer">
          <input type="hidden" class="btn" value="{{ city.id }}" name="cityId">
          <input type="submit" value="Add Post">
          </div>
        </form>


        {% comment %} <form method="POST" action="{% url 'post_new' %}">
          {% csrf_token %}
          {{ post_form.as_p }}
          <input type="submit" class="btn" value="Add Post">
          <input type="hidden" class="btn" value="{{ city.id }}" name="cityId">
        </form>  {% endcomment %}
      </div>
    </div>

  </div>
</div>

<script>
  const edit_modal = document.querySelectorAll('.modal');
  M.Modal.init(edit_modal);

  const reply_modal = document.querySelectorAll('#reply-modal');
  M.Modal.init(reply_modal);

  
 document.querySelector('.reply-modal-trigger').addEventListener('click', function(event) {
      const commentId = this.dataset.commentId 
      document.getElementById('comment-id').setAttribute('value', commentId)
  });

  const textNeedCount = document.querySelectorAll('#new-body');
  M.CharacterCounter.init(textNeedCount);
</script>

{% endblock content %} 